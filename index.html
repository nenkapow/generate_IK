<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Generator IK TIGER → DOCX</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --soft:#020617;
      --fg:#e5e7eb; --fg-dim:#9ca3af;
      --accent:#f97316; --border:#1f2937;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,sans-serif}
    body{margin:0;background:var(--bg);color:var(--fg);}
    h1{font-size:1.4rem;margin:0 0 .75rem}
    .wrap{max-width:1100px;margin:0 auto;padding:1rem;}
    .card{background:var(--panel);border-radius:.75rem;padding:1rem;margin-bottom:1rem;border:1px solid var(--border);}
    label{font-size:.85rem;color:var(--fg-dim);display:block;margin-bottom:.15rem;}
    input,textarea,button{
      font-size:.85rem;border-radius:.5rem;border:1px solid var(--border);
      background:var(--soft);color:var(--fg);padding:.4rem .5rem;
    }
    textarea{width:100%;min-height:70px;resize:vertical;}
    input[type="text"]{width:100%;}
    button{
      cursor:pointer;background:var(--accent);border-color:var(--accent);
      color:#0b1120;font-weight:600;
    }
    button:disabled{opacity:.5;cursor:not-allowed;}
    .row{display:flex;flex-wrap:wrap;gap:.75rem;}
    .row > div{flex:1;min-width:180px;}
    .small{font-size:.75rem;color:var(--fg-dim);}
    .step-card,.img-card{
      border:1px solid var(--border);border-radius:.5rem;padding:.5rem;margin-top:.5rem;
      background:var(--soft);
    }
    .step-header,.img-header{
      display:flex;align-items:center;justify-content:space-between;gap:.5rem;
      font-size:.8rem;color:var(--fg-dim);margin-bottom:.3rem;
    }
    hr{border:none;border-top:1px solid var(--border);margin:.75rem 0;}
    @media(max-width:768px){
      .row{flex-direction:column;}
    }
  </style>

  <!-- PENTING: pakai index.umd.js -->
  <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Generator Instruksi Kerja TIGER → DOCX</h1>
    <div class="small">
      • Header, border, dan layout mengikuti template standar TIGER.<br>
      • Simpan logo sebagai <code>logo-tiger.png</code> di folder yang sama dengan file ini.<br>
      • Setelah klik <strong>Generate DOCX</strong>, file Word akan ter-download dan bisa kamu edit lagi.
    </div>
  </div>

  <!-- 1. HEADER -->
  <div class="card">
    <h2 style="font-size:1rem;margin-top:0;">1. Header Dokumen</h2>
    <div class="row">
      <div>
        <label>Judul Dokumen (tengah)</label>
        <input id="docTitle" type="text" placeholder="INSTRUKSI KERJA PRINTING LC 002 BASE">
      </div>
      <div>
        <label>Nomor Dokumen</label>
        <input id="docNumber" type="text" placeholder="IK/PRO-TP/163">
      </div>
      <div>
        <label>Revisi</label>
        <input id="docRev" type="text" value="00">
      </div>
      <div>
        <label>Tanggal Efektif</label>
        <input id="docDate" type="text" placeholder="16 November 2015">
      </div>
    </div>
  </div>

  <!-- 2. SISTEM MUTU -->
  <div class="card">
    <h2 style="font-size:1rem;margin-top:0;">2. Sistem Manajemen Mutu</h2>
    <div class="small">Bagian judul dan tabel sudah default. Kamu hanya isi teks di bawah ini.</div>
    <label>Ruang Lingkup</label>
    <textarea id="scope" placeholder="Dimulai dari produk hasil injection sampai dipacking di box WIP."></textarea>

    <label style="margin-top:.5rem;">Referensi (satu baris = satu butir)</label>
    <textarea id="refs" placeholder="ISO 9001:2015 pasal 8.5.1&#10;ISO 9001:2015 pasal 8.5.2"></textarea>
  </div>

  <!-- 3. LANGKAH & VISUAL -->
  <div class="card">
    <h2 style="font-size:1rem;margin-top:0;">3. Langkah Kerja & Visual</h2>
    <div class="small">
      • Di dokumen Word nanti dibuat tabel 2 kolom: <strong>Deskripsi</strong> dan <strong>Visual</strong>.<br>
      • Satu “Langkah” di sini = satu nomor langkah (1,2,3,...) di kolom deskripsi.  
      • Nomor gambar kamu isi sendiri (misal: <code>1,2,3</code> atau <code>5-7</code>).
    </div>
    <div id="stepsContainer"></div>
    <button type="button" onclick="addStep()">+ Tambah Langkah</button>

    <hr>

    <h3 style="font-size:.95rem;">Gambar Visual</h3>
    <div class="small">
      • Urutkan sesuai kebutuhan (1 sampai 9 misalnya).  
      • “Label angka” akan ditulis di atas gambar (contoh di template kamu: <code>1,2,3</code> – <code>4.</code> – dll).
    </div>
    <div id="imagesContainer"></div>
    <button type="button" onclick="addImageInput()">+ Tambah Gambar</button>
  </div>

  <!-- 4. TANDA TANGAN -->
  <div class="card">
    <h2 style="font-size:1rem;margin-top:0;">4. Tanda Tangan</h2>
    <div class="row">
      <div>
        <label>Nama Dibuat</label>
        <input id="signCreated" type="text">
        <div class="small">Jabatan fix: Production Supervisor</div>
      </div>
      <div>
        <label>Nama Diperiksa</label>
        <input id="signChecked" type="text">
        <div class="small">Jabatan fix: Admin Production</div>
      </div>
      <div>
        <label>Nama Disetujui</label>
        <input id="signApproved" type="text" placeholder="Musana">
        <div class="small">Jabatan fix: Factory Manager</div>
      </div>
    </div>
  </div>

  <!-- ACTION -->
  <div class="card" style="text-align:right;">
    <button type="button" onclick="generateDoc()">Generate DOCX</button>
  </div>
</div>

<script>
  // ===== UI helper: langkah & gambar =====
  let stepCounter = 0;
  let imgCounter = 0;

  function addStep() {
    stepCounter++;
    const wrap = document.getElementById("stepsContainer");
    const div = document.createElement("div");
    div.className = "step-card";
    div.dataset.stepId = stepCounter;

    div.innerHTML = `
      <div class="step-header">
        <span>Langkah #${stepCounter}</span>
        <button type="button" onclick="this.closest('.step-card').remove()">hapus</button>
      </div>
      <label>Deskripsi langkah</label>
      <textarea data-role="step-desc"></textarea>
    `;
    wrap.appendChild(div);
  }

  function addImageInput() {
    imgCounter++;
    const wrap = document.getElementById("imagesContainer");
    const div = document.createElement("div");
    div.className = "img-card";
    div.dataset.imgId = imgCounter;

    div.innerHTML = `
      <div class="img-header">
        <span>Gambar #${imgCounter}</span>
        <button type="button" onclick="this.closest('.img-card').remove()">hapus</button>
      </div>
      <div class="row">
        <div>
          <label>File gambar</label>
          <input type="file" accept="image/*" data-role="img-file">
        </div>
        <div>
          <label>Label angka di atas gambar</label>
          <input type="text" placeholder="1,2,3" data-role="img-label">
        </div>
      </div>
    `;
    wrap.appendChild(div);
  }

  // default 1 langkah + 1 gambar
  addStep();
  addImageInput();

  // helper baca file ke ArrayBuffer
  function fileToArrayBuffer(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = e => reject(e);
      reader.readAsArrayBuffer(file);
    });
  }

  // ====== GENERATE DOCX ======
  async function generateDoc() {
    if (!window.docx) {
      alert("Library DOCX belum ke-load.\nCoba refresh (Ctrl+F5) dan pastikan koneksi ke https://unpkg.com tidak diblokir.");
      return;
    }

    const {
      Document, Packer, Paragraph, TextRun,
      Table, TableRow, TableCell,
      WidthType, AlignmentType, BorderStyle, Media
    } = window.docx;

    // ---- ambil data form ----
    const title      = document.getElementById("docTitle").value || "INSTRUKSI KERJA";
    const number     = document.getElementById("docNumber").value || "IK/PRO-TP/XXX";
    const rev        = document.getElementById("docRev").value || "00";
    const effDate    = document.getElementById("docDate").value || "";
    const scope      = document.getElementById("scope").value.trim();
    const refsRaw    = document.getElementById("refs").value.trim();

    const signCreated  = document.getElementById("signCreated").value || "";
    const signChecked  = document.getElementById("signChecked").value || "";
    const signApproved = document.getElementById("signApproved").value || "Musana";

    // langkah
    const stepDescs = [];
    document.querySelectorAll(".step-card textarea[data-role='step-desc']")
      .forEach((ta)=>{
        const v = ta.value.trim();
        if (v) stepDescs.push(v);
      });

    // gambar
    const imgCards = document.querySelectorAll(".img-card");
    const imageInfos = [];

    // doc harus dibuat dulu sebelum Media.addImage
    const doc = new Document({
      sections: [],
      creator: "Generator IK TIGER"
    });

    // baca logo dari logo-tiger.png
    let logoImage = null;
    try {
      const res = await fetch("logo-tiger.png");
      if (res.ok) {
        const buf = await res.arrayBuffer();
        logoImage = Media.addImage(doc, buf, 90, 90);
      }
    } catch (e) {
      // kalau gagal ya sudah, nanti diganti tulisan "TIGER"
    }

    // baca semua gambar visual
    for (const card of imgCards) {
      const fileInput  = card.querySelector("[data-role='img-file']");
      const labelInput = card.querySelector("[data-role='img-label']");
      if (fileInput && fileInput.files && fileInput.files[0]) {
        const buf = await fileToArrayBuffer(fileInput.files[0]);
        const img = Media.addImage(doc, buf, 150, 100);
        imageInfos.push({
          label: (labelInput.value || "").trim(),
          image: img
        });
      }
    }

    // ====== 1) HEADER TABLE ======
    const borderAll = {
      top:{style:BorderStyle.SINGLE,size:4,color:"000000"},
      bottom:{style:BorderStyle.SINGLE,size:4,color:"000000"},
      left:{style:BorderStyle.SINGLE,size:4,color:"000000"},
      right:{style:BorderStyle.SINGLE,size:4,color:"000000"},
      insideHorizontal:{style:BorderStyle.SINGLE,size:4,color:"000000"},
      insideVertical:{style:BorderStyle.SINGLE,size:4,color:"000000"},
    };

    const headerTable = new Table({
      width:{size:100,type:WidthType.PERCENTAGE},
      borders:borderAll,
      rows:[
        new TableRow({
          children:[
            new TableCell({
              children:[ logoImage
                ? new Paragraph(logoImage)
                : new Paragraph({alignment:AlignmentType.CENTER,children:[
                    new TextRun({text:"TIGER",bold:true})
                  ]})
              ],
            }),
            new TableCell({
              children:[
                new Paragraph({
                  alignment:AlignmentType.CENTER,
                  children:[
                    new TextRun({text:title,bold:true})
                  ]
                })
              ]
            }),
            new TableCell({
              children:[
                new Paragraph({
                  children:[
                    new TextRun({text:"Nomor",bold:true}),
                    new TextRun({text:" : "+number})
                  ]
                })
              ]
            }),
            new TableCell({
              children:[
                new Paragraph({
                  children:[
                    new TextRun({text:"Revisi",bold:true}),
                    new TextRun({text:" : "+rev})
                  ]
                })
              ]
            })
          ]
        }),
        new TableRow({
          children:[
            new TableCell({children:[new Paragraph("")]}),
            new TableCell({children:[new Paragraph("")]}),
            new TableCell({
              children:[
                new Paragraph({
                  children:[
                    new TextRun({text:"Tgl Efektif",bold:true}),
                    new TextRun({text:" : "+effDate})
                  ]
                })
              ]
            }),
            new TableCell({
              children:[
                new Paragraph({
                  children:[
                    new TextRun({text:"Hal.",bold:true}),
                    new TextRun({text:" : 1 / 1"})
                  ]
                })
              ]
            })
          ]
        })
      ]
    });

    // ====== 2) SISTEM MANAJEMEN MUTU ======
    const isoTitle = [
      new Paragraph({
        alignment:AlignmentType.CENTER,
        children:[new TextRun({text:"SISTEM MANAJEMEN MUTU",bold:true})]
      }),
      new Paragraph({
        alignment:AlignmentType.CENTER,
        children:[new TextRun({text:"ISO 9001:2015",bold:true})]
      }),
      new Paragraph({text:""})
    ];

    const scopeParas = [
      new Paragraph({
        children:[ new TextRun({text:"Ruang Lingkup",bold:true,underline:{} }) ]
      }),
      new Paragraph({text: scope || ""}),
      new Paragraph({text:""})
    ];

    const refParas = [];
    refParas.push(new Paragraph({
      children:[ new TextRun({text:"Referensi:",bold:true,underline:{}}) ]
    }));

    if (refsRaw) {
      const lines = refsRaw.split(/\r?\n/).filter(l=>l.trim()!=="");
      lines.forEach((line,idx)=>{
        refParas.push(
          new Paragraph({
            children:[
              new TextRun({text:(idx+1)+". "+line})
            ]
          })
        );
      });
    }
    refParas.push(new Paragraph({text:""}));

    // tabel riwayat perubahan (kosong untuk diisi manual)
    const historyTable = new Table({
      width:{size:100,type:WidthType.PERCENTAGE},
      borders:borderAll,
      rows:[
        new TableRow({
          children:[
            new TableCell({children:[new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:"No.",bold:true})]})]}),
            new TableCell({children:[new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:"Revisi",bold:true})]})]}),
            new TableCell({children:[new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:"Tanggal",bold:true})]})]}),
            new TableCell({children:[new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:"Diusulkan Oleh",bold:true})]})]}),
            new TableCell({children:[new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:"Uraian Singkat Perubahan",bold:true})]})]}),
          ]
        }),
        // 3 baris kosong
        ...[1,2,3].map(()=> new TableRow({
          children:[
            new TableCell({children:[new Paragraph("")]}),
            new TableCell({children:[new Paragraph("")]}),
            new TableCell({children:[new Paragraph("")]}),
            new TableCell({children:[new Paragraph("")]}),
            new TableCell({children:[new Paragraph("")]}),
          ]
        }))
      ]
    });

    // ====== 3) TABEL LANGKAH & VISUAL ======
    const stepParagraphs = [];
    if (stepDescs.length === 0) {
      stepParagraphs.push(new Paragraph("1. ................................................"));
    } else {
      stepDescs.forEach((s,i)=>{
        stepParagraphs.push(
          new Paragraph({
            children:[ new TextRun({text:(i+1)+". "+s}) ]
          })
        );
      });
    }

    const visualParagraphs = [];
    if (imageInfos.length === 0) {
      visualParagraphs.push(new Paragraph(" "));
    } else {
      imageInfos.forEach(info=>{
        if (info.label) {
          visualParagraphs.push(
            new Paragraph({
              alignment:AlignmentType.CENTER,
              children:[new TextRun({text:info.label,bold:true})]
            })
          );
        }
        visualParagraphs.push(
          new Paragraph({alignment:AlignmentType.CENTER,children:[info.image]})
        );
      });
    }

    const stepVisualTable = new Table({
      width:{size:100,type:WidthType.PERCENTAGE},
      borders:borderAll,
      rows:[
        new TableRow({
          children:[
            new TableCell({
              children:[new Paragraph({
                alignment:AlignmentType.CENTER,
                children:[new TextRun({text:"Deskripsi",bold:true})]
              })]
            }),
            new TableCell({
              children:[new Paragraph({
                alignment:AlignmentType.CENTER,
                children:[new TextRun({text:"Visual",bold:true})]
              })]
            })
          ]
        }),
        new TableRow({
          children:[
            new TableCell({children:stepParagraphs}),
            new TableCell({children:visualParagraphs})
          ]
        })
      ]
    });

    // ====== 4) TANDA TANGAN TABLE ======
    const signTable = new Table({
      width:{size:100,type:WidthType.PERCENTAGE},
      borders:borderAll,
      rows:[
        new TableRow({
          children:[
            new TableCell({children:[new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:"Dibuat",bold:true})]})]}),
            new TableCell({children:[new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:"Diperiksa",bold:true})]})]}),
            new TableCell({children:[new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:"Disetujui",bold:true})]})]}),
          ]
        }),
        new TableRow({
          children:[
            new TableCell({children:[new Paragraph(" ")]}),
            new TableCell({children:[new Paragraph(" ")]}),
            new TableCell({children:[new Paragraph(" ")]}),
          ]
        }),
        new TableRow({
          children:[
            new TableCell({children:[new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:signCreated,bold:true})]})]}),
            new TableCell({children:[new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:signChecked,bold:true})]})]}),
            new TableCell({children:[new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:signApproved,bold:true})]})]}),
          ]
        }),
        new TableRow({
          children:[
            new TableCell({children:[new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:"Production Supervisor"})]})]}),
            new TableCell({children:[new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:"Admin Production"})]})]}),
            new TableCell({children:[new Paragraph({alignment:AlignmentType.CENTER,children:[new TextRun({text:"Factory Manager"})]})]}),
          ]
        })
      ]
    });

    // ====== SUSUN SEMUA KE DALAM 1 SECTION ======
    doc.addSection({
      properties:{},
      children:[
        headerTable,
        new Paragraph({text:""}),
        ...isoTitle,
        ...scopeParas,
        ...refParas,
        historyTable,
        new Paragraph({text:""}),
        stepVisualTable,
        new Paragraph({text:""}),
        signTable
      ]
    });

    // ====== EXPORT ======
    const blob = await Packer.toBlob(doc);
    const fileNameSafe = (title || "Instruksi Kerja").replace(/[\\/:*?"<>|]/g,"_");
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = fileNameSafe + ".docx";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }
</script>
</body>
</html>
